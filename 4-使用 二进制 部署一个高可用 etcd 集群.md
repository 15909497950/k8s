# 使用 二进制 部署一个高可用 etcd 集群

## 一. 配置证书签发的工具
```
# chmod +x cfssl cfssljson 
# mv cfssl cfssljson /usr/local/bin/
```
## 二. 创建etcd证书：
### 1. 创建证书存放目录
```
mkdir -p {config,pki}
```
### 2.创建ca-config.json文件
```
# cat > config/ca-config.json <<EOF
{
  "signing": {
    "default": {
        "usages": [
          "signing",
          "key encipherment",
          "server auth",
          "client auth"
        ],
        "expiry": "876000h"
    }
  }
}
EOF
```

### 3. 创建ca-csr.jason文件
```
 # cat > config/ca-csr.jason  <<EOF
{
  "CN": "Autogenerated CA",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "O": "Honest Achmed's Used Certificates",
      "OU": "Hastily-Generated Values Divison",
      "L": "San Francisco",
      "ST": "California",
      "C": "US"
    }
  ]
}
EOF
```

### 4. 生成CA证书:
```
cfssl gencert -initca config/ca-csr.jason | cfssljson -bare pki/ca
```

### 5. 创建 etcd-csr.json 文件
hosts包含etcd所有主机IP地址
```
# cat <<EOF > config/etcd-server-csr.json 
{
  "CN": "etcd",
  "hosts": [
    "localhost",
    "127.0.0.1",
    "192.168.26.10",
    "192.168.26.11",
    "192.168.26.12"
  ],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "O": "autogenerated",
      "OU": "etcd cluster",
      "L": "the internet"
    }
  ]
}
EOF
```

### 6. 生成ETCD Server证书: 
```
cfssl gencert \
  -ca=pki/ca.pem \
  -ca-key=pki/ca-key.pem \
  -config=config/ca-config.json  \
  config/etcd-server-csr.json | cfssljson -bare pki/etcd-server

cfssl gencert \
  -ca=pki/ca.pem \
  -ca-key=pki/ca-key.pem \
  -config=config/ca-config.json  \
  config/etcd-server-csr.json | cfssljson -bare pki/etcd-peer
```

### 7. 创建 apiserver-etcd-client-csr.json 文件
包含所有的apiserver和VIP地址
```
# cat <<EOF > config/apiserver-etcd-client-csr.json 
{
  "CN": "etcd",
  "hosts": [
    "192.168.26.14",
    "192.168.26.15",
    "192.168.26.16",
    "192.168.26.17"          
  ],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "O": "autogenerated",
      "OU": "etcd cluster",
      "L": "the internet"
    }
  ]
}
EOF
```
### 8. 生成Apiserver和ETCD通讯证书: 
```
cfssl gencert \
  -ca=pki/ca.pem \
  -ca-key=pki/ca-key.pem \
  -config=config/ca-config.json  \
  config/apiserver-etcd-client-csr.json | cfssljson -bare pki/apiserver-etcd-client
```

### 9. 拷贝证书到所有ETCD节点：
```
ETCD_NODE0=192.168.26.10
ETCD_NODE1=192.168.26.11
ETCD_NODE2=192.168.26.12

mkdir -p /usr/local/etcd/ssl
cp pki/{ca.pem,etcd-server.pem,etcd-server-key.pem,etcd-peer.pem,etcd-peer-key.pem} /usr/local/etcd/ssl

for ETCD_IP in ${ETCD_NODE1} ${ETCD_NODE2};do
  ssh ${ETCD_IP} mkdir -p /usr/local/etcd/ssl
  scp /usr/local/etcd/ssl/* ${ETCD_IP}:/usr/local/etcd/ssl/
done
```

### 10. 把apiserver需要的证书拷贝到第一个master节点：
```
MASTER_NODE0=192.168.26.15

scp pki/{apiserver-etcd-client.pem,apiserver-etcd-client-key.pem} ${MASTER_NODE0}:/etc/kubernetes/pki/
scp pki/ca.pem ${MASTER_NODE0}:/etc/kubernetes/pki/etcd/ca.pem
```

## 三. 二进制安装ETCD
### 1. 上传etcd二进制包到服务器
下载地址： https://github.com/etcd-io/etcd
```
tar -xvf etcd-v3.4.15-linux-amd64.tar.gz 
cp etcd-v3.4.15-linux-amd64/etcd* /usr/local/bin/
```

### 配置etcd.service
```
# cat <<'EOF' > /usr/lib/systemd/system/etcd.service
[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target

[Service]
Type=notify
ExecStart=/usr/local/bin/etcd \
--advertise-client-urls=https://192.168.26.10:2379 \
--cert-file=/usr/local/etcd/ssl/etcd-server.pem \
--client-cert-auth=true \
--data-dir=/var/lib/etcd \
--initial-advertise-peer-urls=https://192.168.26.10:2380 \
--initial-cluster=vms10=https://192.168.26.10:2380,vms11=https://192.168.26.11:2380,vms12=https://192.168.26.12:2380 \
--key-file=/usr/local/etcd/ssl/etcd-server-key.pem \
--listen-client-urls=https://192.168.26.10:2379,https://127.0.0.1:2379 \
--listen-metrics-urls=https://127.0.0.1:2381 \
--listen-peer-urls=https://192.168.26.10:2380 \
--name=vms10 \      
--peer-cert-file=/usr/local/etcd/ssl/etcd-peer.pem \
--peer-client-cert-auth=true \
--peer-key-file=/usr/local/etcd/ssl/etcd-peer-key.pem \
--peer-trusted-ca-file=/usr/local/etcd/ssl/ca.pem \
--trusted-ca-file=/usr/local/etcd/ssl/ca.pem \
--snapshot-count=10000 \
--initial-cluster-state new \
--initial-cluster-token etcd-cluster-0 

Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF
```
注意修改参数--name= 和 实际情况的IP地址

### 3. 启动etcd服务：
```
systemctl daemon-reload 
systemctl enable etcd --now
systemctl status etcd -l
```

重启服务
```
systemctl daemon-reload 
systemctl restart etcd
systemctl status etcd -l
```

### 4. 检查ETCD集群健康状态
```
# etcdctl \
  --cert /usr/local/etcd/ssl/etcd-peer.pem \
  --key /usr/local/etcd/ssl/etcd-peer-key.pem \
  --cacert /usr/local/etcd/ssl/ca.pem \
  --endpoints https://192.168.26.10:2379 endpoint health --cluster
```

```
cd pki/

etcdctl \
--cert apiserver-etcd-client.pem \
--key apiserver-etcd-client-key.pem \
--cacert ca.pem \
--endpoints https://192.168.26.10:2379 endpoint health --cluster
```

参考：https://github.com/etcd-io/etcd/tree/main/hack/tls-setup